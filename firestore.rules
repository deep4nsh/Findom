rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    function isSignedIn() { return request.auth != null; }
    function isSelf(userId) { return isSignedIn() && request.auth.uid == userId; }

    // 1) Users (optional; app stores some data in /users)
    match /users/{userId} {
      allow read, create: if isSelf(userId);
      // Prevent userType tampering on update
      allow update: if isSelf(userId) && request.resource.data.userType == resource.data.userType;
      allow delete: if false;

      // Reminders sub-collection rules (Added to fix PERMISSION_DENIED)
      match /reminders/{reminderId} {
        allow read, write: if isSelf(userId);
      }
    }

    // 2) Role-based profiles used by the app
    // Professionals are discoverable if verified; otherwise only the owner can read.
    match /professionals/{userId} {
      allow read: if request.auth != null;
      allow create, update, delete: if request.auth.uid == userId;
    }

    match /students/{userId} {
      allow read: if request.auth != null;
      allow create, update, delete: if request.auth.uid == userId;
    }

    match /general_users/{userId} {
      allow read: if request.auth != null;
      allow create, update, delete: if request.auth.uid == userId;
    }

    match /companies/{companyId} {
      allow read: if request.auth != null;
      allow create, update, delete: if request.auth.uid == companyId;
    }

    // 3) Posts + Likes + Comments
    match /posts/{postId} {
      // Feed is visible to signed-in users
      allow read: if isSignedIn();

      // Only the post author can create the post with their authorId
      allow create: if isSignedIn() && request.auth.uid == request.resource.data.authorId;

      // Updates:
      // - Author can update anything on their own post
      // - Any signed-in user may update ONLY the 'likes' field (to like/unlike)
      allow update: if (
        (isSignedIn() && request.auth.uid == resource.data.authorId) ||
        (
          isSignedIn() &&
          // Only 'likes' may change
          request.resource.data.diff(resource.data).changedKeys().hasOnly(['likes'])
        )
      );

      // Only the author can delete
      allow delete: if isSignedIn() && request.auth.uid == resource.data.authorId;

      // Comments subcollection
      match /comments/{commentId} {
        allow read: if isSignedIn();
        // Author of the comment can create
        allow create: if isSignedIn() && request.auth.uid == request.resource.data.authorId;
        // Optional: only allow updates/deletes by the comment author
        allow update, delete: if isSignedIn() && request.auth.uid == resource.data.authorId;
      }
    }

    // 4) Social graph (followers / following)
    // Batch writes:
    // - /following/{currentUserId}/userFollowing/{targetId}  (written by current user)
    // - /followers/{targetId}/userFollowers/{currentUserId}  (written by current user)
    match /following/{userId}/userFollowing/{targetId} {
      allow read: if isSignedIn();
      allow write: if isSelf(userId);
      allow delete: if isSelf(userId);
    }
    match /followers/{userId}/userFollowers/{followerId} {
      allow read: if isSignedIn();
      // Only the follower (current user) may add/remove themselves
      allow write, delete: if isSelf(followerId);
    }

    // 5) Jobs
    match /jobs/{jobId} {
      // Public job board reads
      allow read: if true;
      // Simplified: any signed-in can post; tighten to company-only if needed
      allow create, update, delete: if isSignedIn();
    }
  }
}
